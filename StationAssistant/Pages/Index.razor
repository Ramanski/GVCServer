@page "/"
@using StationAssistant.Data.Entities;
@using Syncfusion.Blazor.Cards;
@inject NotificationService NotificationService
@inject StationAssistant.Data.IStationDataService StationDataService
@attribute [Authorize]

<AuthorizeView>
    <Authorized>
        <h5>Вход осущствлен в роли "@context.User.Claims.Where(cl => cl.Type == System.Security.Claims.ClaimTypes.Role).FirstOrDefault()?.Value.ToLower()"</h5>
    </Authorized>
    <NotAuthorized>
        <h5>Вход осущствлен в роли "анонимный пользователь"</h5>
    </NotAuthorized>
</AuthorizeView>

<div class="row">
    <div class="col-6 p-2">
        <SfCard>
            <CardHeader>Прибытие поездов</CardHeader>
            <CardContent>
                <table>
                    <tr>
                        <td>Поездов прибыло:</td>
                        <td>@(arrivedTrains == null? 0: arrivedTrains.Count())</td>
                    </tr>
                    <tr>
                        <td>Вагонов прибыло:</td>
                        <td>@(arrivedTrains == null? 0: arrivedTrains.Sum(t => t.Length))</td>
                    </tr>
                    <tr>
                        <td>Общий вес:</td>
                        <td>@(arrivedTrains == null? 0: arrivedTrains.Sum(t=>t.WeightBrutto)/10) тонн</td>
                    </tr>
                </table>
            </CardContent>
            <CardFooter>
                <NavLink class="btn btn-primary" href="arrival">
                    Перейти к прибытию
                </NavLink>
            </CardFooter>
        </SfCard>
    </div>
    <div class="col-6 p-2">
        <SfCard>
            <CardHeader>Отправление поездов</CardHeader>
            <CardContent>
                <table>
                    <tr>
                        <td>Поездов сформировано:</td>
                        <td>@(departingTrains == null? 0: departingTrains.Count())</td>
                    </tr>
                    <tr>
                        <td>Вагонов сформировано:</td>
                        <td>@(departingTrains == null? 0: departingTrains.Sum(t => t.Length))</td>
                    </tr>
                    <tr>
                        <td>Общий вес:</td>
                        <td>@(departingTrains == null? 0: departingTrains.Sum(t=>t.WeightBrutto)/10) тонн</td>
                    </tr>
                </table>
            </CardContent>
            <CardFooter>
                <NavLink class="btn btn-primary" href="departure">
                    Перейти к отправлению
                </NavLink>
            </CardFooter>
        </SfCard>
    </div>
</div>
<div class="row">
    <div class="col-6 p-2">
        <SfCard>
            <CardHeader>Парки путей</CardHeader>
            <CardContent>
                @if (paths != null)
                {
                    <table>
                        @foreach (string area in paths.Select(p => p.Area).Distinct())
                        {
                            <tr>
                                <td>@area.Trim():</td>
                                <td>@paths.Where(p => p.AnyTrain && p.Area == area).Count() из @paths.Where(p => p.Area == area).Count() путей занято </td>
                            </tr>
                        }
                    </table>
                }
            </CardContent>
            <CardFooter>
                <NavLink class="btn btn-primary" href="paths">
                    Перейти к вагонам на путях
                </NavLink>
            </CardFooter>
        </SfCard>
    </div>
    <div class="col-6 p-2">
        <SfCard>
            <CardHeader>Накопление</CardHeader>
            <CardContent>
                @if (directions != null)
                {
                    <table>
                        @{var tracks = directions.Select(d => d.Track).Distinct();
                            foreach (string track in tracks)
                            {
                                var directionStations = directions.Where(d => d.Track == track).Select(d => d.StationDestination);
                                var vagonsToDirection = vagons.Where(v => directionStations.Contains(v.PlanForm) && v.TrainIndex == null);
                                <tr>
                                    <td>@track:</td>
                                    <td>@(vagonsToDirection == null ? 0 : vagonsToDirection.Count()) (порожних @(vagonsToDirection == null ? 0 : vagonsToDirection.Where(v => v.WeightNetto == 0).Count()))</td>
                                </tr>
                            }
                        }
                    </table>
                }
            </CardContent>
            <CardFooter>
                <NavLink class="btn btn-primary" href="paths">
                    Перейти накоплению на путях
                </NavLink>
            </CardFooter>
        </SfCard>
    </div>
</div>


@code {

    List<TrainModel> arrivedTrains;
    List<TrainModel> departingTrains;
    List<Vagon> vagons;
    List<PathModel> paths;
    string[] areas;
    Direction[] directions;

    protected override async Task OnInitializedAsync()
    {
        var trains = await StationDataService.GetAllTrainsAsync();
        if (trains != null)
        {
            arrivedTrains = trains.Where(t => t.Index.Substring(9, 4) == "1613").ToList();
            departingTrains = trains.Where(t => t.Index.Substring(0, 4) == "1613").ToList();
        }
        //areas = await StationDataService.GetAreasAsync();
        paths = await StationDataService.GetPaths();
        directions = await StationDataService.GetDirections();
        vagons = await StationDataService.GetVagons();
    }
}